# Simulatte Next: Refactor Plan (RL-PPC DES core + Warehouses/AGVs)

Last updated: 2025-12-11  
Author: Codex (draft for review)

## Objectives
- Replace existing Simulatte core with the discrete-event simulation (DES) foundation from `rl-ppc` (Environment, ShopFloor, Router, Server, PSP, policies, builders, runner).
- Preserve and modernize *capabilities* of current Simulatte AGV + Warehouse domain, not their implementation details.
- Model **Warehouse**, its subcomponents (aisles/locations/buffers), and **AGV** as first-class `Server` subclasses so they share queue/utilization KPIs and scheduling semantics.
- Enable simulations of (a) job-shop flows exactly as in `rl-ppc` and (b) optional material-handling flows that deliver workpieces via warehouses and AGV fleets to processing servers.
- No backward compatibility required; codebase may be reorganized freely.

## Non-Goals
- RL agents, Gym wrappers, training loops, wandb integration.
- Legacy Simulatte controllers, logging/plotting, or old API stability.
- Detailed physics/path-planning for AGVs; focus is queue/mission timing with travel times supplied by policies/helpers.

## Constraints & Principles
- Keep `rl-ppc` style: singleton `Environment`, builder-driven system construction, event-driven release/dispatch policies.
- All resource-like entities inherit from the new `Server` (or a thin mixin over it) to unify metrics and queue behavior.
- Favor composition of processes registered on the shared `Environment` over deep inheritance of behavior.
- Avoid duplicating logic across job-shop and warehouse/AGV flows; reuse Router/PSP where possible.

## Target Architecture (high level)
**Core runtime (ported from rl-ppc)**
- `Environment`, `Singleton`, `Runner`, `distributions`, `typing`.
- `Server` (priority resource with queue/utilization history), `ShopFloor`, `Job`, `Router`, `PSP` + release policies (LUMS-COR, SLAR, DRACO, starvation helpers).
- `builders` to assemble baseline systems (push, lumscor, slar, draco) with 6 single-capacity processing servers.

**Material-handling extensions**
- `MaterialServer` (abstract): extends `Server` with optional capacity >1, load/unload times, and travel-time hooks.
- `AGVServer`: subclass of `MaterialServer`; encapsulates mission/trip bookkeeping (statuses, travel/wait/idle time, load/unload); exposes priorities for dispatch queues.
- `WarehouseServer`: subclass of `MaterialServer`; represents an entry/exit interface plus internal routing to child servers.
- `WarehouseLocationServer`: leaf server for a physical slot/side/floor; inherits `Server` for queue/utilization metrics.
- `ConveyorBufferServer` (if needed): simple FIFO server for staging input/output streams.
- Hierarchy: `WarehouseServer` owns internal `WarehouseLocationServer` instances and optional buffers; dispatch policies map incoming jobs/unit-loads to internal servers.

**Flows**
- **Production jobs (as in rl-ppc)**: generated by `Router`, optionally require a preceding material delivery step; if enabled, a “materialization” policy assigns a warehouse location and schedules AGV pick/drop before the first processing server.
- **Material handling jobs**: represent unit-load transfers; can reuse `Job` or a lightweight `TransferTask` mapped onto `Server` requests (AGV → warehouse location → processing server input buffer).
- **Policies**: reuse PSP release/dispatch; add optional AGV dispatch policy (choose AGV for a transfer) and warehouse storage/retrieval policy (location selection).

## Workstreams & Milestones
1) **Core Import & Renaming**
   - Copy/rename `rl-ppc` DES modules into new Simulatte namespace.
   - Strip RL-only packages (`agents`, `training`, `thurer_*`, Gym env).
   - Preserve tests/fixtures where applicable (adapt paths).

2) **Server Unification**
   - Keep `Server` API intact; ensure priority queues, queue/utilization history stay central.
   - Add minimal extension hooks (`on_request`, `on_release`) for downstream servers.

3) **Material Server Layer**
   - Introduce `MaterialServer` base (load/unload durations, travel_time_fn hook).
   - Implement `AGVServer` (mission tracking akin to current AGV, but server semantics; travel time via scenario-provided callable with default Euclidean helper).
   - Implement `WarehouseLocationServer` (depth/side/floor metadata; capacity=1 by default).
   - Implement `WarehouseServer` orchestrating internal servers and staging buffers; exposes external `request`/`release` like any server.

4) **Flow Integration**
   - Extend `Router` to optionally prepend a “materialization” step: create storage job + delivery job before first processing server.
   - Define mapping from production job to warehouse/AGV tasks (policy-based; default noop).
   - Ensure PSP/ShopFloor KPIs remain valid with added steps; material handling gated by a global enable flag.

5) **Policies & Builders**
   - Add default warehouse policies: nearest-location, first-empty, product-slotting placeholder.
   - Add AGV dispatch policy: least-busy or shortest ETA.
   - Provide new builders:
     - `build_system_push_with_materials`
     - `build_system_lumscor_with_materials`
     - Minimal “warehouse-only” demo (store ↔ agv ↔ dock).
   - Global toggle for material handling; per-job material requirements remain parametric (e.g., job family metadata).

6) **Metrics & Observability**
   - Reuse server queue/utilization; add mission/transport KPIs (travel time, loaded vs empty miles).
   - Keep EMAs for production KPIs; add hooks for warehouse saturation and AGV fleet utilization.

7) **Docs & Examples**
   - Update `simulatte-architecture.md` to new reality.
   - Add small example scripts: (a) classic 6-server job shop; (b) same with warehouse+AGV supply; (c) warehouse-only pallet moves.
   - Provide barebones plotting utilities (queues/utilization, AGV mission timelines); richer visualization deferred to later task.

8) **Cleanup**
   - Remove legacy Simulatte modules not mapped to new design.
   - Align packaging, naming, and CLI (if retained) to new module layout.

## Open Design Questions (resolved)
1) AGV travel time: scenario-provided callable (default helper can wrap Euclidean distance + speed).
2) Warehouse locations: start with capacity=1 (depth=1) for v1; extend later.
3) Material handling: globally enabled/disabled; per-job material requirements remain parametric on job definition.
4) Plotting: provide barebones plotting (queues/utilization/mission timelines) in this refactor; richer visualization deferred.

## Risk/Scope Notes
- Converting all warehouse subcomponents into `Server` subclasses may inflate queue data; we’ll keep a light interface and allow disabling per-location histories if performance becomes an issue.
- Singleton `Environment` simplifies wiring but needs careful reset (`Singleton.clear()`) between runs; tests must enforce this.
- AGV path planning is intentionally simplified; revisit if spatial congestion becomes a target metric.

## Success Criteria (for first iteration)
- Can run existing `rl-ppc` job-shop scenarios unchanged (API parity with builders).
- New warehouse+AGV builders produce consistent SimPy runs with unified KPIs (queue lengths/utilization available for warehouses/locations/AGVs).
- Core modules contain no legacy Simulatte-only dependencies; AGV/Warehouse are expressed as `Server` subclasses.
